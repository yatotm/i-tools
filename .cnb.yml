.make-image-envs-cnb: &make-image-envs-cnb
  - name: set IMAGE_NAME
    script: echo -n "$CNB_REPO_SLUG"
    exports:
      info: IMAGE_NAME
  - name: set IMAGE_VERSION
    script: echo -n "$CNB_BRANCH" | cut -d "/" -f1
    exports:
      info: IMAGE_VERSION
  - name: use latest if main
    if: |
      [ "$CNB_BRANCH" = "main" ]
    script: echo -n "latest"
    exports:
      info: IMAGE_VERSION
  # - name: set IMAGE_NAME_WITH_TAG
  #   script: echo -n "${CNB_DOCKER_REGISTRY}/${IMAGE_NAME}:${IMAGE_VERSION}"
  #   exports:
  #     info: IMAGE_NAME_WITH_TAG
  - name: SET TAGS
    script: |
      REGISTRY_LIST="$CNB_DOCKER_REGISTRY ghcr.io"
      
      TAGS=""
      
      # ä¸ºæ¯ä¸ªä»“åº“ç”Ÿæˆæ ‡ç­¾
      for registry in $REGISTRY_LIST; do
        # æ ‡ç­¾
        TAGS="${TAGS} ${registry}/${IMAGE_NAME}:${IMAGE_VERSION}"        
        # æ·»åŠ Git SHAæ ‡ç­¾
        TAGS="${TAGS} ${registry}/${IMAGE_NAME}:${CNB_COMMIT_SHORT}"
      done
      
      echo -n "$TAGS"
    exports:
      info: BUILD_TAGS

.build-by-arch-cnb: &build-by-arch-cnb
  - name: docker login for docker.cnb.cool
    script: docker login -u "$CNB_TOKEN_USER_NAME" -p "$CNB_TOKEN" $CNB_DOCKER_REGISTRY
  - name: docker login for ghcr.io
    script: docker login -u "$GITHUB_USERNAME" -p "$GITHUB_PACKAGE_TOKEN" ghcr.io
  - name: set DOCKERFILE_DIR
    script: |
      if [ -f "docker/Dockerfile.linux.$BUILD_ARCH" ]; then
        echo -n "docker/Dockerfile.linux.$BUILD_ARCH"
      else
        echo -n "Dockerfile"
      fi
    exports:
      info: DOCKERFILE_DIR
  - name: docker build & push
    if: |
      [ -f $DOCKERFILE_DIR ]
    script:
      - |
        # æ„å»ºå‘½ä»¤ï¼Œå°†æ‰€æœ‰æ ‡ç­¾æ·»åŠ åˆ°buildå‘½ä»¤ä¸­
        BUILD_CMD="docker build -f $DOCKERFILE_DIR"
        for tag in $BUILD_TAGS; do
          BUILD_CMD="$BUILD_CMD -t $tag"
        done
        BUILD_CMD="$BUILD_CMD ."
        echo "æ‰§è¡Œæ„å»ºå‘½ä»¤: $BUILD_CMD"
        eval $BUILD_CMD
      - |
        # æ¨é€æ‰€æœ‰æ ‡ç­¾ï¼Œå¸¦é”™è¯¯å¤„ç†
        PUSH_SUCCESS=0
        PUSH_FAILED=0
        
        for tag in $BUILD_TAGS; do
          echo "æ­£åœ¨æ¨é€: $tag"
          if docker push $tag; then
            echo "âœ… æˆåŠŸæ¨é€: $tag"
            PUSH_SUCCESS=$((PUSH_SUCCESS + 1))
          else
            echo "âŒ æ¨é€å¤±è´¥: $tag"
            PUSH_FAILED=$((PUSH_FAILED + 1))
          fi
        done
        
        echo "æ¨é€ç»Ÿè®¡: æˆåŠŸ $PUSH_SUCCESS ä¸ªï¼Œå¤±è´¥ $PUSH_FAILED ä¸ª"
        
        # å¦‚æœæœ‰æ¨é€å¤±è´¥ï¼Œä½†è‡³å°‘æœ‰ä¸€ä¸ªæˆåŠŸï¼Œç»™å‡ºè­¦å‘Š
        if [ $PUSH_FAILED -gt 0 ] && [ $PUSH_SUCCESS -gt 0 ]; then
          echo "âš ï¸  éƒ¨åˆ†æ¨é€å¤±è´¥ï¼Œè¯·æ£€æŸ¥ä»“åº“æƒé™å’Œç½‘ç»œè¿æ¥"
          exit 1
        elif [ $PUSH_FAILED -gt 0 ]; then
          echo "âŒ æ‰€æœ‰æ¨é€éƒ½å¤±è´¥äº†"
          exit 1
        else
          echo "ğŸ‰ æ‰€æœ‰é•œåƒæ¨é€æˆåŠŸï¼"
        fi
  - name: resolve 
    type: cnb:resolve
    options:
      key: build-cnb-$BUILD_ARCH

.amd64-arch-build-cnb: &amd64-arch-build-cnb
  name: build-amd64-cnb
  runner:
    tags: cnb:arch:amd64
  services:
    - docker
  env:
    BUILD_ARCH: amd64
  imports: https://cnb.cool/ilay1678/cloud-native-build/-/blob/main/github_secret.yml
  stages:
    - *make-image-envs-cnb
    - *build-by-arch-cnb

.arm64-arch-build-cnb: &arm64-arch-build-cnb
  name: build-arm64-cnb
  runner:
    tags: cnb:arch:arm64:v8
  env:
    BUILD_ARCH: arm64
  imports: https://cnb.cool/ilay1678/cloud-native-build/-/blob/main/github_secret.yml
  services:
    - docker
  stages:
    - *make-image-envs-cnb
    - *build-by-arch-cnb

# .multi-arch-push: &multi-arch-push-cnb
#   - name: await the amd64
#     type: cnb:await
#     options:
#       key: build-cnb-amd64
#   - name: await the arm64
#     type: cnb:await
#     options:
#       key: build-cnb-arm64
#   - name: manifest
#     image: cnbcool/manifest:latest
#     settings:
#       target: $IMAGE_NAME_WITH_TAG
#       template: ${IMAGE_NAME_WITH_TAG}-OS-ARCH
#       platforms:
#         - linux/amd64
#         - linux/arm64

main:
  push:
    - *amd64-arch-build-cnb
    - *arm64-arch-build-cnb
    # - name: conbine-arch-cnb
    #   imports: https://cnb.cool/ilay1678/cloud-native-build/-/blob/main/github_secret.yml
    #   services:
    #     - docker    
    #   stages:
    #     - *make-image-envs-cnb
    #     - *multi-arch-push-cnb